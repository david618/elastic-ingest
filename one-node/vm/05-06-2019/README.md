
#### Create Kafka Topic

```
ssh a41
sudo su - kafka
./kafka/bin/kafka-topics.sh --zookeeper a41:2181 --topic planes3 --create --replication-factor 1 --partitions 3
```

#### Run Spark Job

```
ssh m1
sudo su - spark
```

Sparktest Command


```
/opt/spark/bin/spark-submit \
--conf spark.executor.cores=5 \
--conf spark.cores.max=9 \
--conf spark.executor.memory=5000m \
--conf spark.es.batch.size.bytes=421000000 \
--conf spark.es.batch.size.entries=50000 \
--conf spark.es.batch.write.refresh=false \
--conf spark.streaming.concurrentJobs=64 \
--conf spark.scheduler.mode=FAIR \
--conf spark.locality.wait=0s \
--conf spark.streaming.kafka.consumer.cache.enabled=false \
--class org.jennings.estest.SendKafkaTopicElasticsearch /home/spark/sparktest/target/sparktest-full.jar \
spark://m1:7077 1000 a41:9092 group1 planes9 1 \
a101 9200 - - 9 true false true planes 60s 10000 0 false
```

#### Elastic Index Mon (EIM)

Secure shell to boot from another terminal.

```
ssh p1
cd rttest
java -cp target/rttest.jar com.esri.rttest.mon.ElasticIndexMon http://a101:9200/planes 60 3
```

#### Kafka Topic Mon (KTM)

Secure shell to boot from another terminal.

```
ssh p1
cd rttest
java -cp target/rttest.jar com.esri.rttest.mon.KafkaTopicMon a41:9092 planes3
```

#### Send Kafka

```
cd rttest
bash sendPlanes a41:9092 planes9 planes00000 200 40 2
```

#### Test Results

KTM: 400k/s

##### Test 1

|Query Number|Sample Number|Epoch (ms)    |Time (s) |Count             |Linear Reg. Rate  |Rate From Previous|Rate From First   |
|------------|-------------|--------------|---------|------------------|------------------|------------------|------------------|
|          1 |           1 |1557180578792 |       0 |        1,605,872 |                  |                  |                  |
|          2 |           2 |1557180638793 |      60 |        4,232,307 |           43,773 |           43,773 |           43,773 |
|          3 |           3 |1557180698810 |     120 |        9,297,153 |           64,085 |           84,390 |           64,084 |
|          4 |           4 |1557180758790 |     179 |       12,697,926 |           63,901 |           56,698 |           61,623 |
|          5 |           5 |1557180818791 |     239 |       14,851,915 |           58,264 |           35,899 |           55,192 |
|          6 |           6 |1557180878795 |     300 |       20,965,468 |           62,885 |          101,886 |           64,531 |
|          7 |           7 |1557180938791 |     359 |       22,884,354 |           61,225 |           31,984 |           59,107 |
|          8 |           8 |1557180998854 |     420 |       26,398,613 |           60,307 |           58,510 |           59,022 |
|          9 |           9 |1557181058802 |     480 |       31,321,184 |           61,331 |           82,114 |           61,906 |
|         10 |          10 |1557181118790 |     539 |       36,211,718 |           62,953 |           81,525 |           64,085 |
|         11 |       ***** |1557181178912 |     600 |       36,211,718 |           62,953 |                0 |           57,665 |
|         12 |          11 |1557181238791 |     659 |       40,621,048 |           61,343 |           36,744 |           59,114 |
|         13 |          12 |1557181298795 |     720 |       44,816,491 |           60,887 |           69,919 |           60,014 |
|         14 |          13 |1557181358800 |     780 |       45,933,985 |           59,300 |           18,623 |           56,830 |
|         15 |          14 |1557181418797 |     840 |       51,770,178 |           59,362 |           97,275 |           59,719 |
|         16 |          15 |1557181478803 |     900 |       53,539,306 |           58,714 |           29,483 |           57,703 |
|         17 |          16 |1557181538795 |     960 |       57,023,707 |           58,272 |           58,081 |           57,727 |
|         18 |          17 |1557181598791 |    1019 |       61,477,059 |           58,254 |           74,227 |           58,697 |
|         19 |          18 |1557181658793 |    1080 |       63,312,946 |           57,801 |           30,597 |           57,136 |
|         20 |          19 |1557181718792 |    1140 |       66,111,361 |           57,314 |           46,641 |           56,584 |
|         21 |          20 |1557181778803 |    1200 |       71,176,391 |           57,309 |           84,402 |           57,975 |
|         22 |          21 |1557181838802 |    1260 |       71,618,236 |           56,713 |            7,364 |           55,565 |
|         23 |          22 |1557181898796 |    1320 |       75,762,150 |           56,396 |           69,072 |           56,179 |
|         24 |          23 |1557181958794 |    1380 |       77,961,961 |           55,955 |           36,665 |           55,330 |
|         25 |          24 |1557182018795 |    1440 |       80,000,000 |           55,410 |           33,967 |           54,440 |
|         26 |       ***** |1557182078796 |    1500 |       80,000,000 |           55,410 |                0 |           52,263 |
|         27 |       ***** |1557182138797 |    1560 |       80,000,000 |           55,410 |                0 |           50,252 |


For last 180  seconds the count has not increased...

Removing sample: 1620|80000000

Total Count: 80,000,000 | Linear Regression Rate:  55,955 | Linear Regression Standard Error: 0.69 | Average Rate: 55,330

##### Test 2


|Query Number|Sample Number|Epoch (ms)    |Time (s) |Count             |Linear Reg. Rate  |Rate From Previous|Rate From First   |
|------------|-------------|--------------|---------|------------------|------------------|------------------|------------------|
|          1 |           1 |1557189514263 |       0 |          250,714 |                  |                  |                  |
|          2 |           2 |1557189574277 |      60 |        2,804,309 |           42,550 |           42,550 |           42,550 |
|          3 |           3 |1557189634263 |     120 |        8,668,142 |           70,143 |           97,753 |           70,145 |
|          4 |           4 |1557189694458 |     180 |        9,819,616 |           57,554 |           19,129 |           53,103 |
|          5 |           5 |1557189754262 |     239 |       14,230,151 |           58,268 |           73,750 |           58,248 |
|          6 |           6 |1557189814285 |     300 |       19,868,372 |           63,568 |           93,934 |           65,387 |
|          7 |       ***** |1557189874262 |     359 |       19,868,372 |           63,568 |                0 |           54,494 |
|          8 |           7 |1557189934264 |     420 |       25,388,455 |           61,639 |           46,009 |           59,852 |
|          9 |           8 |1557189994280 |     480 |       29,355,643 |           61,406 |           66,102 |           60,633 |
|         10 |           9 |1557190054321 |     540 |       30,516,783 |           58,853 |           19,339 |           56,042 |
|         11 |          10 |1557190114264 |     600 |       35,305,698 |           58,573 |           79,891 |           58,425 |
|         12 |          11 |1557190174272 |     660 |       40,048,574 |           59,215 |           79,037 |           60,299 |
|         13 |          12 |1557190234265 |     720 |       40,623,891 |           57,957 |            9,590 |           56,074 |
|         14 |          13 |1557190294265 |     780 |       44,556,570 |           57,393 |           65,545 |           56,802 |
|         15 |          14 |1557190354271 |     840 |       49,099,963 |           57,484 |           75,716 |           58,153 |
|         16 |          15 |1557190414288 |     900 |       51,951,654 |           57,326 |           47,515 |           57,444 |
|         17 |          16 |1557190474263 |     960 |       54,033,488 |           56,776 |           34,712 |           56,024 |
|         18 |          17 |1557190534275 |    1020 |       59,641,662 |           57,031 |           93,451 |           58,226 |
|         19 |          18 |1557190594286 |    1080 |       61,378,802 |           56,772 |           28,947 |           56,599 |
|         20 |          19 |1557190654267 |    1140 |       64,610,210 |           56,541 |           53,874 |           56,456 |
|         21 |          20 |1557190714374 |    1200 |       69,890,276 |           56,778 |           87,844 |           58,028 |
|         22 |          21 |1557190774268 |    1260 |       70,821,545 |           56,466 |           15,549 |           56,008 |
|         23 |          22 |1557190834269 |    1320 |       74,877,796 |           56,350 |           67,603 |           56,535 |
|         24 |          23 |1557190894264 |    1380 |       78,884,312 |           56,366 |           66,781 |           56,981 |
|         25 |          24 |1557190954264 |    1440 |       79,797,804 |           55,995 |           15,225 |           55,241 |
|         26 |          25 |1557191014264 |    1500 |       80,000,000 |           55,249 |            3,370 |           53,166 |
|         27 |       ***** |1557191074265 |    1560 |       80,000,000 |           55,249 |                0 |           51,121 |
|         28 |       ***** |1557191134265 |    1620 |       80,000,000 |           55,249 |                0 |           49,228 |

For last 180  seconds the count has not increased...
Removing sample: 1680|80000000
Total Count: 80,000,000 | Linear Regression Rate:  55,995 | Linear Regression Standard Error: 0.54 | Average Rate: 55,241

##### Test 3

bash sendPlanes a41:9092 planes9 planes00000 200 40 2


|Query Number|Sample Number|Epoch (ms)    |Time (s) |Count             |Linear Reg. Rate  |Rate From Previous|Rate From First   |
|------------|-------------|--------------|---------|------------------|------------------|------------------|------------------|
|          1 |           1 |1557192044038 |       0 |        2,031,288 |                  |                  |                  |
|          2 |           2 |1557192104039 |      60 |        4,467,059 |           40,596 |           40,596 |           40,596 |
|          3 |           3 |1557192164037 |     119 |        8,052,755 |           50,179 |           59,764 |           50,179 |
|          4 |           4 |1557192224043 |     180 |       14,250,977 |           67,073 |          103,293 |           67,885 |
|          5 |           5 |1557192284037 |     239 |       16,499,220 |           64,533 |           37,474 |           60,283 |
|          6 |           6 |1557192344039 |     300 |       18,676,367 |           59,771 |           36,285 |           55,483 |
|          7 |           7 |1557192404041 |     360 |       22,318,700 |           58,171 |           60,704 |           56,353 |
|          8 |           8 |1557192464039 |     420 |       25,959,537 |           57,713 |           60,683 |           56,972 |
|          9 |           9 |1557192524038 |     480 |       26,252,959 |           53,978 |            4,890 |           50,462 |
|         10 |          10 |1557192584038 |     540 |       28,412,435 |           51,096 |           35,991 |           48,854 |
|         11 |          11 |1557192644041 |     600 |       32,023,215 |           49,936 |           60,177 |           49,986 |
|         12 |          12 |1557192704039 |     660 |       32,675,551 |           47,765 |           10,873 |           46,431 |
|         13 |          13 |1557192764065 |     720 |       37,593,190 |           47,579 |           81,925 |           49,390 |
|         14 |          14 |1557192824040 |     780 |       43,019,495 |           48,687 |           90,476 |           52,549 |
|         15 |          15 |1557192884040 |     840 |       44,383,184 |           48,759 |           22,728 |           50,419 |
|         16 |          16 |1557192944043 |     900 |       47,269,835 |           48,792 |           48,108 |           50,265 |
|         17 |          17 |1557193004066 |     960 |       52,659,841 |           49,620 |           89,799 |           52,737 |
|         18 |          18 |1557193064041 |    1020 |       54,860,300 |           49,974 |           36,690 |           51,793 |
|         19 |          19 |1557193124258 |    1080 |       56,932,235 |           49,980 |           34,408 |           50,824 |
|         20 |          20 |1557193184765 |    1140 |       61,673,578 |           50,394 |           78,360 |           52,284 |
|         21 |          21 |1557193244044 |    1200 |       64,670,740 |           50,702 |           50,560 |           52,199 |
|         22 |          22 |1557193304042 |    1260 |       66,396,912 |           50,674 |           28,770 |           51,084 |
|         23 |          23 |1557193364153 |    1320 |       71,218,355 |           50,974 |           80,209 |           52,410 |
|         24 |          24 |1557193424051 |    1380 |       73,873,330 |           51,138 |           44,325 |           52,059 |
|         25 |          25 |1557193484786 |    1440 |       76,216,106 |           51,149 |           38,574 |           51,490 |
|         26 |          26 |1557193544044 |    1500 |       81,078,633 |           51,418 |           82,057 |           52,698 |
|         27 |          27 |1557193604046 |    1560 |       81,690,032 |           51,305 |           10,190 |           51,063 |
|         28 |          28 |1557193665191 |    1621 |       86,823,589 |           51,460 |           83,957 |           52,304 |
|         29 |          29 |1557193724049 |    1680 |       90,400,606 |           51,648 |           60,774 |           52,600 |
|         30 |          30 |1557193784043 |    1740 |       91,520,244 |           51,588 |           18,662 |           51,430 |
|         31 |          31 |1557193844947 |    1800 |       96,022,507 |           51,676 |           73,924 |           52,191 |
|         32 |          32 |1557193904045 |    1860 |       99,809,968 |           51,818 |           64,088 |           52,569 |
|         33 |          33 |1557193964410 |    1920 |      100,336,280 |           51,704 |            8,719 |           51,191 |
|         34 |          34 |1557194024047 |    1980 |      104,352,064 |           51,687 |           67,337 |           51,677 |
|         35 |          35 |1557194084059 |    2040 |      108,524,280 |           51,758 |           69,523 |           52,202 |
|         36 |          36 |1557194144523 |    2100 |      109,142,174 |           51,629 |           10,219 |           50,993 |
|         37 |          37 |1557194204968 |    2160 |      113,628,801 |           51,617 |           74,227 |           51,643 |
|         38 |          38 |1557194264055 |    2220 |      116,538,026 |           51,598 |           49,236 |           51,579 |
|         39 |          39 |1557194324047 |    2280 |      118,243,072 |           51,492 |           28,421 |           50,970 |
|         40 |          40 |1557194384046 |    2340 |      122,566,300 |           51,476 |           72,055 |           51,511 |
|         41 |          41 |1557194444046 |    2400 |      124,050,984 |           51,370 |           24,745 |           50,841 |
|         42 |          42 |1557194504097 |    2460 |      127,188,665 |           51,281 |           52,250 |           50,876 |
|         43 |          43 |1557194564054 |    2520 |      131,574,882 |           51,273 |           73,156 |           51,406 |
|         44 |          44 |1557194624065 |    2580 |      131,959,425 |           51,130 |            6,408 |           50,359 |
|         45 |          45 |1557194684051 |    2640 |      134,959,050 |           51,002 |           50,005 |           50,351 |
|         46 |          46 |1557194744302 |    2700 |      138,208,378 |           50,898 |           53,930 |           50,431 |
|         47 |       ***** |1557194804047 |    2760 |      138,208,378 |           50,898 |                0 |           49,339 |
|         48 |          47 |1557194864694 |    2820 |      141,068,876 |           50,654 |           23,760 |           49,293 |
|         49 |          48 |1557194924592 |    2880 |      142,934,279 |           50,390 |           31,143 |           48,915 |
|         50 |          49 |1557194984805 |    2940 |      144,487,083 |           50,097 |           25,789 |           48,442 |
|         51 |          50 |1557195044236 |    3000 |      146,727,591 |           49,812 |           37,699 |           48,229 |
|         52 |          51 |1557195104091 |    3060 |      148,569,957 |           49,517 |           30,780 |           47,888 |
|         53 |          52 |1557195164159 |    3120 |      150,337,958 |           49,212 |           29,433 |           47,532 |
|         54 |          53 |1557195224141 |    3180 |      152,797,651 |           48,925 |           41,007 |           47,409 |
|         55 |          54 |1557195286644 |    3242 |      154,849,043 |           48,636 |           32,821 |           47,128 |
|         56 |          55 |1557195344510 |    3300 |      156,221,441 |           48,332 |           23,717 |           46,718 |
|         57 |          56 |1557195404759 |    3360 |      158,145,270 |           48,030 |           31,931 |           46,453 |
|         58 |          57 |1557195464165 |    3420 |      161,066,411 |           47,762 |           49,172 |           46,500 |
|         59 |          58 |1557195525037 |    3480 |      164,009,801 |           47,522 |           48,354 |           46,532 |
|         60 |          59 |1557195584099 |    3540 |      164,570,478 |           47,244 |            9,493 |           45,914 |
|         61 |          60 |1557195644448 |    3600 |      167,715,207 |           47,001 |           52,109 |           46,018 |
|         62 |          61 |1557195704285 |    3660 |      169,452,868 |           46,754 |           29,040 |           45,741 |
|         63 |          62 |1557195764909 |    3720 |      171,727,073 |           46,516 |           37,513 |           45,606 |
|         64 |          63 |1557195824053 |    3780 |      173,355,436 |           46,273 |           27,532 |           45,324 |
|         65 |          64 |1557195884051 |    3840 |      176,787,471 |           46,068 |           57,202 |           45,509 |
|         66 |          65 |1557195944057 |    3900 |      177,983,300 |           45,846 |           19,928 |           45,116 |
|         67 |          66 |1557196004052 |    3960 |      181,977,781 |           45,671 |           66,580 |           45,441 |
|         68 |          67 |1557196064089 |    4020 |      185,722,566 |           45,533 |           62,375 |           45,694 |
|         69 |          68 |1557196124197 |    4080 |      186,226,422 |           45,360 |            8,383 |           45,144 |
|         70 |          69 |1557196184051 |    4140 |      190,611,796 |           45,236 |           73,268 |           45,551 |
|         71 |          70 |1557196244536 |    4200 |      191,962,428 |           45,095 |           22,330 |           45,216 |
|         72 |          71 |1557196306025 |    4261 |      193,778,790 |           44,947 |           29,540 |           44,990 |
|         73 |          72 |1557196364051 |    4320 |      194,660,003 |           44,779 |           15,187 |           44,590 |
|         74 |       ***** |1557196424053 |    4380 |      194,660,003 |           44,779 |                0 |           43,979 |
|         75 |       ***** |1557196484051 |    4440 |      194,660,003 |           44,779 |                0 |           43,385 |

For last 180  seconds the count has not increased...
Removing sample: 4500|194660003
Total Count: 194,660,003 | Linear Regression Rate:  44,947 | Linear Regression Standard Error: 0.47 | Average Rate: 44,990

Spark Job failed before all 240 Million messages passed throught; throughput fell to 45k/s before failure.

##### Test 4

bash sendPlanes a41:9092 planes9 planes00000 20 720 2


Will send 1.440 billion messages at 40k/s.   Should take about 10 hours to complete.


Running task in background to see if they will continue to run.

java -cp target/rttest.jar com.esri.rttest.mon.KafkaTopicMon a41:9092 planes9 > ktm.log 2>&1 &

java -cp target/rttest.jar com.esri.rttest.mon.ElasticIndexMon http://a101:9200/planes 60 3 > eim.log 2>&1 &


/opt/spark/bin/spark-submit --conf spark.executor.cores=5 --conf spark.cores.max=9 --conf spark.executor.memory=5000m --conf spark.es.batch.size.bytes=421000000 --conf spark.es.batch.size.entries=50000 --conf spark.es.batch.write.refresh=false --conf spark.es.nodes.discovery=false --conf spark.es.nodes.data.only=false --conf spark.es.nodes.wan.only=true --conf spark.streaming.concurrentJobs=64 --conf spark.scheduler.mode=FAIR --conf spark.locality.wait=0s --class org.jennings.estest.SendKafkaTopicElasticsearch /home/spark/sparktest/target/sparktest-full.jar spark://m1:7077 1000 a41:9092 group1 planes9 1 a101 9200 - - 9 true false true planes 60s 10000 0 false > sparkjob.log 2>&1  &

First attempt: Spark Job failed after about 30 mins.  Errors about Kafka Partitions.  Deleted and recreated the Kafka Topic

Second attempt: Spark Job lasted a little longer but also died 

