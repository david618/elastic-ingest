
### Create Topic

** 3 May 2019 **


```
kubectl exec -it gateway-cp-kafka-0 --container cp-kafka-broker bash
kafka-topics --zookeeper gateway-cp-zookeeper:2181 --topic planes9 --create --replication-factor 1 --partitions 9
```

### Deploy Sparktest

```
kubectl apply -f fabric8-rbac.yaml

kubectl apply -f sparktest.yaml
```

### Run Spark Job from Sparktest

```
kubectl exec -it sparktest-bccc588d9-8f8vl tmux
```


```
/opt/spark/bin/spark-submit \
--master k8s://https://kubernetes:443 \
--deploy-mode cluster \
--conf spark.executor.instances=9 \
--conf spark.executor.cores=5 \
--conf spark.executor.memory=5000m \
--conf spark.es.batch.size.bytes=421000000 \
--conf spark.es.batch.size.entries=50000 \
--conf spark.es.batch.write.refresh=false \
--conf spark.streaming.concurrentJobs=64 \
--conf spark.scheduler.mode=FAIR \
--conf spark.locality.wait=0s \
--conf spark.streaming.kafka.consumer.cache.enabled=false \
--conf spark.kubernetes.container.image=david62243/sparktest:v0.4-2.3.2 \
--conf spark.kubernetes.container.forcePullImage=true \
--conf spark.kubernetes.driver.label.appname=sparktest-es \
--conf spark.kubernetes.executor.label.appname=sparktest-es \
--class org.jennings.estest.SendKafkaTopicElasticsearch local:///opt/spark/work-dir/sparktest-full.jar \
k8s://https://kubernetes:443 1000 gateway-cp-kafka:9092 group1 planes9 1 \
datastore-elasticsearch-client-headless 9200 - - 9 true false true planes 60s 10000 0 false
```

#### Deploy rttest-send

```
kubectl apply -f rttest-send.yaml
```

#### ElasticIndexMon

```
kubectl exec -it rttest-send-0 tmux
cd /opt/rttest
java -cp target/rttest.jar com.esri.rttest.mon.ElasticIndexMon http://datastore-elasticsearch-client-headless:9200/planes 10 12
```

#### KafkaTopicMon

```
kubectl exec -it rttest-send-1 tmux
cd /opt/rttest
java -cp target/rttest.jar com.esri.rttest.mon.KafkaTopicMon gateway-cp-kafka:9092 planes9
```

#### Send Kafka
```
kubectl exec -it rttest-send-2 tmux
cd /opt/rttest
bash sendPlanes gateway-cp-kafka:9092 planes9 planes00000 200 75 1
```


#### Sending 200k/s


```
bash sendPlanes gateway-cp-kafka:9092 planes9 planes00000 200 75 1
```

##### Config

Kafka
- No resource request/limits
- Xms/Xmx at 512M for both zookeeper and brokers

Datastore
- Three masters
  - Xms/Xmx at 1g
  - Request: 100m and 1Gi
- Three client (data/ingest)
  - Xms/Xmx at 26g
  - Request: 100m and 26Gi
  

##### KafkaTopicMon

|Sample Number|Epoch|Count|Linear Regression Rate|Approx. Instantaneous Rate|
|-------------|-----|-----|----------------------|--------------------------|
| 1 | 1556906114906 | 118450 |           |           |
| 2 | 1556906119907 | 1226629 | 221591 | 221591 |
| 3 | 1556906124908 | 2229202 | 211033 | 200475 |
| 4 | 1556906129906 | 3219828 | 206131 | 198204 |
| 5 | 1556906134906 | 4223515 | 204071 | 200737 |
| 6 | 1556906139907 | 5228885 | 203049 | 201034 |
| 7 | 1556906144908 | 6229215 | 202359 | 200026 |
| 8 | 1556906149908 | 7215537 | 201648 | 197264 |
| 9 | 1556906154908 | 8225253 | 201335 | 201943 |
| 10 | 1556906159909 | 9220274 | 201047 | 198964 |
| 11 | 1556906164908 | 10231261 | 200944 | 202238 |
| 12 | 1556906169908 | 11227866 | 200822 | 199321 |
| 13 | 1556906174908 | 12229746 | 200733 | 200376 |
| 14 | 1556906179908 | 13224312 | 200626 | 198913 |
| 15 | 1556906184909 | 14235991 | 200598 | 202295 |
| 16 | 1556906189908 | 15237477 | 200573 | 200337 |
| 17 | 1556906194908 | 16213062 | 200449 | 195117 |
| 18 | 1556906199908 | 17238054 | 200442 | 204998 |
| 19 | 1556906204909 | 18238644 | 200431 | 200078 |
| 20 | 1556906209908 | 19238285 | 200417 | 199968 |
| 21 | 1556906214908 | 20234169 | 200390 | 199177 |
| 22 | 1556906219908 | 21212799 | 200314 | 195726 |
| 23 | 1556906224908 | 22229242 | 200289 | 203289 |
| 24 | 1556906229910 | 23220845 | 200250 | 198241 |
| 25 | 1556906234909 | 24209762 | 200196 | 197823 |
| 26 | 1556906239909 | 25233980 | 200194 | 204844 |
| 27 | 1556906244909 | 26225188 | 200177 | 198242 |
| 28 | 1556906249909 | 27216830 | 200149 | 198328 |
| 29 | 1556906254909 | 28225664 | 200138 | 201767 |
| 30 | 1556906259909 | 29237631 | 200144 | 202393 |
| 31 | 1556906264909 | 30235732 | 200145 | 199620 |
| 32 | 1556906269909 | 31210952 | 200117 | 195044 |
| 33 | 1556906274909 | 32240134 | 200125 | 205836 |
| 34 | 1556906279909 | 33213593 | 200104 | 194692 
| 35 | 1556906284908 | 34223083 | 200095 | 201938 |
| 36 | 1556906289908 | 35237123 | 200099 | 202808 |
| 37 | 1556906294908 | 36241546 | 200107 | 200885 |
| 38 | 1556906299909 | 37235159 | 200107 | 198683 |
| 39 | 1556906304909 | 38236026 | 200108 | 200173 |
| 40 | 1556906309909 | 39245079 | 200115 | 201811 |
| 41 | 1556906314910 | 40206951 | 200093 | 192336 |
| 42 | 1556906319910 | 41243744 | 200099 | 207359 |
| 43 | 1556906324909 | 42223048 | 200091 | 195900 |
| 44 | 1556906329910 | 43224892 | 200084 | 200329 |
| 45 | 1556906334910 | 44219408 | 200075 | 198903 |
| 46 | 1556906339914 | 45219486 | 200066 | 199856 |
| 47 | 1556906344910 | 46222480 | 200061 | 200759 |
| 48 | 1556906349909 | 47242416 | 200066 | 204028 |
| 49 | 1556906354909 | 48217218 | 200058 | 194960 |
| 50 | 1556906359910 | 49204681 | 200045 | 197453 |
| 51 | 1556906364910 | 50245989 | 200052 | 208262 |
| 52 | 1556906369909 | 51224226 | 200048 | 195687 |
| 53 | 1556906374910 | 52207285 | 200038 | 196572 |
| 54 | 1556906379910 | 53206216 | 200028 | 199786 |
| 55 | 1556906384910 | 54243524 | 200034 | 207462 |
| 56 | 1556906389910 | 55251756 | 200042 | 201646 |
| 57 | 1556906394909 | 56240599 | 200046 | 197808 |
| 58 | 1556906399910 | 57220085 | 200041 | 195858 |
| 59 | 1556906404912 | 58242101 | 200045 | 204321 |
| 60 | 1556906409911 | 59244451 | 200048 | 200510 |
| 61 | 1556906414910 | 60230446 | 200047 | 197238 |
| 62 | 1556906419910 | 61215711 | 200042 | 197053 |
| 63 | 1556906424911 | 62212125 | 200036 | 199243 |
| 64 | 1556906429910 | 63229518 | 200035 | 203519 |
| 65 | 1556906434910 | 64237113 | 200036 | 201519 |
| 66 | 1556906439912 | 65223236 | 200034 | 197146 |
| 67 | 1556906444911 | 66229526 | 200033 | 201298 |
| 68 | 1556906449912 | 67232085 | 200033 | 200472 |
| 69 | 1556906454912 | 68233640 | 200033 | 200311 |
| 70 | 1556906459912 | 69241264 | 200036 | 201525 |
| 71 | 1556906464914 | 70248527 | 200039 | 201372 |
| 72 | 1556906469912 | 71201881 | 200032 | 190747 |
| 73 | 1556906474913 | 72219290 | 200029 | 203441 |
| 74 | 1556906479915 | 73243196 | 200031 | 204699 |
| 75 | 1556906484913 | 74213427 | 200027 | 194124 |
| 76 | 1556906489914 | 75000000 | 199979 | 157283 |

Count is no longer increasing...

Removing sample: 1556906489914|75000000

Total Count: 75,000,000 | Linear Regression Rate:  200,027 | Average Rate: 200,253

##### ElasticIndexMon

|Query Number|Sample Number|Epoch (ms)    |Time (s) |Count             |Linear Reg. Rate  |Rate From Previous|Rate From First   |
|------------|-------------|--------------|---------|------------------|------------------|------------------|------------------|
|          1 |           1 |1556906153815 |       0 |          387,294 |                  |                  |                  |
|          2 |       ***** |1556906163279 |       9 |          387,294 |                  |                  |                  |
|          3 |       ***** |1556906173272 |      19 |          387,294 |                  |                  |                  |
|          4 |       ***** |1556906183131 |      29 |          387,294 |                  |                  |                  |
|          5 |       ***** |1556906193502 |      39 |          387,294 |                  |                  |                  |
|          6 |       ***** |1556906203320 |      49 |          387,294 |                  |                  |                  |
|          7 |       ***** |1556906213197 |      59 |          387,294 |                  |                  |                  |
|          8 |           2 |1556906223341 |      69 |          896,772 |            7,328 |            7,328 |            7,328 |
|          9 |           3 |1556906233223 |      79 |        1,423,798 |           10,940 |           53,332 |           13,053 |
|         10 |           4 |1556906243103 |      89 |        1,981,172 |           14,834 |           56,414 |           17,851 |
|         11 |       ***** |1556906252841 |      99 |        1,981,172 |           14,834 |                0 |           16,096 |
|         12 |       ***** |1556906263587 |     109 |        1,981,172 |           14,834 |                0 |           14,520 |
|         13 |       ***** |1556906273215 |     119 |        1,981,172 |           14,834 |                0 |           13,349 |
|         14 |       ***** |1556906283487 |     129 |        1,981,172 |           14,834 |                0 |           12,292 |
|         15 |       ***** |1556906292927 |     139 |        1,981,172 |           14,834 |                0 |           11,458 |
|         16 |           5 |1556906303155 |     149 |        2,177,685 |           12,772 |            3,272 |           11,989 |
|         17 |           6 |1556906313120 |     159 |        2,774,904 |           14,208 |           59,932 |           14,988 |
|         18 |           7 |1556906323157 |     169 |        3,764,000 |           17,367 |           98,545 |           19,940 |
|         19 |       ***** |1556906332844 |     179 |        3,764,000 |           17,367 |                0 |           18,861 |
|         20 |       ***** |1556906343103 |     189 |        3,764,000 |           17,367 |                0 |           17,839 |
|         21 |       ***** |1556906353169 |     199 |        3,764,000 |           17,367 |                0 |           16,938 |
|         22 |       ***** |1556906363191 |     209 |        3,764,000 |           17,367 |                0 |           16,127 |
|         23 |       ***** |1556906373514 |     219 |        3,764,000 |           17,367 |                0 |           15,370 |
|         24 |       ***** |1556906382916 |     229 |        3,764,000 |           17,367 |                0 |           14,739 |
|         25 |           8 |1556906393125 |     239 |        4,586,372 |           18,274 |           11,754 |           17,547 |
|         26 |           9 |1556906403172 |     249 |        5,198,784 |           19,514 |           60,955 |           19,296 |
|         27 |          10 |1556906412934 |     259 |        5,597,987 |           20,475 |           40,894 |           20,109 |
|         28 |       ***** |1556906423267 |     269 |        5,597,987 |           20,475 |                0 |           19,338 |
|         29 |       ***** |1556906433507 |     279 |        5,597,987 |           20,475 |                0 |           18,630 |
|         30 |       ***** |1556906442870 |     289 |        5,597,987 |           20,475 |                0 |           18,027 |
|         31 |       ***** |1556906453155 |     299 |        5,597,987 |           20,475 |                0 |           17,407 |
|         32 |       ***** |1556906463076 |     309 |        5,597,987 |           20,475 |                0 |           16,849 |
|         33 |          11 |1556906473250 |     319 |        6,004,136 |           19,783 |            6,734 |           17,584 |
|         34 |          12 |1556906483005 |     329 |        7,057,561 |           20,532 |          107,988 |           20,263 |
|         35 |          13 |1556906493188 |     339 |        7,475,610 |           21,191 |           41,054 |           20,887 |
|         36 |       ***** |1556906503330 |     349 |        7,475,610 |           21,191 |                0 |           20,280 |
|         37 |       ***** |1556906512925 |     359 |        7,475,610 |           21,191 |                0 |           19,739 |
|         38 |       ***** |1556906522982 |     369 |        7,475,610 |           21,191 |                0 |           19,201 |
|         39 |       ***** |1556906533153 |     379 |        7,475,610 |           21,191 |                0 |           18,686 |
|         40 |          14 |1556906543168 |     389 |        7,681,746 |           20,817 |            4,124 |           18,735 |
|         41 |          15 |1556906553251 |     399 |        8,275,107 |           20,912 |           58,848 |           19,747 |
|         42 |          16 |1556906562940 |     409 |        9,253,352 |           21,528 |          100,964 |           21,671 |
|         43 |       ***** |1556906573032 |     419 |        9,253,352 |           21,528 |                0 |           21,149 |
|         44 |       ***** |1556906582869 |     429 |        9,253,352 |           21,528 |                0 |           20,664 |
|         45 |       ***** |1556906593265 |     439 |        9,253,352 |           21,528 |                0 |           20,175 |
|         46 |       ***** |1556906603046 |     449 |        9,253,352 |           21,528 |                0 |           19,736 |
|         47 |          17 |1556906613035 |     459 |        9,450,458 |           21,397 |            3,935 |           19,736 |
|         48 |          18 |1556906623063 |     469 |        9,840,535 |           21,416 |           38,899 |           20,146 |
|         49 |          19 |1556906632971 |     479 |       10,848,983 |           21,853 |          101,781 |           21,834 |
|         50 |          20 |1556906642857 |     489 |       11,061,467 |           22,176 |           21,493 |           21,827 |
|         51 |       ***** |1556906653373 |     499 |       11,061,467 |           22,176 |                0 |           21,367 |
|         52 |       ***** |1556906663346 |     509 |       11,061,467 |           22,176 |                0 |           20,949 |
|         53 |       ***** |1556906673146 |     519 |       11,061,467 |           22,176 |                0 |           20,554 |
|         54 |       ***** |1556906682907 |     529 |       11,061,467 |           22,176 |                0 |           20,175 |
|         55 |          21 |1556906693054 |     539 |       11,295,465 |           22,030 |            4,662 |           20,229 |
|         56 |          22 |1556906703062 |     549 |       11,957,074 |           22,113 |           66,108 |           21,065 |
|         57 |          23 |1556906712850 |     559 |       13,057,612 |           22,515 |          112,437 |           22,665 |
|         58 |       ***** |1556906723007 |     569 |       13,057,612 |           22,515 |                0 |           22,260 |
|         59 |       ***** |1556906733109 |     579 |       13,057,612 |           22,515 |                0 |           21,872 |
|         60 |       ***** |1556906743264 |     589 |       13,057,612 |           22,515 |                0 |           21,495 |
|         61 |       ***** |1556906752887 |     599 |       13,057,612 |           22,515 |                0 |           21,150 |
|         62 |       ***** |1556906762926 |     609 |       13,057,612 |           22,515 |                0 |           20,801 |
|         63 |          24 |1556906772903 |     619 |       13,290,611 |           22,428 |            3,880 |           20,842 |
|         64 |          25 |1556906783580 |     629 |       13,972,589 |           22,521 |           63,874 |           21,572 |
|         65 |          26 |1556906792977 |     639 |       15,115,342 |           22,890 |          121,608 |           23,043 |
|         66 |       ***** |1556906802852 |     649 |       15,115,342 |           22,890 |                0 |           22,692 |
|         67 |       ***** |1556906812898 |     659 |       15,115,342 |           22,890 |                0 |           22,346 |
|         68 |       ***** |1556906823024 |     669 |       15,115,342 |           22,890 |                0 |           22,008 |
|         69 |       ***** |1556906832938 |     679 |       15,115,342 |           22,890 |                0 |           21,687 |
|         70 |       ***** |1556906842983 |     689 |       15,115,342 |           22,890 |                0 |           21,371 |
|         71 |          27 |1556906853059 |     699 |       15,581,243 |           22,921 |            7,754 |           21,729 |
|         72 |          28 |1556906862943 |     709 |       16,733,620 |           23,215 |          116,590 |           23,051 |
|         73 |          29 |1556906873050 |     719 |       17,208,369 |           23,510 |           46,972 |           23,387 |
|         74 |       ***** |1556906883252 |     729 |       17,208,369 |           23,510 |                0 |           23,060 |
|         75 |       ***** |1556906892929 |     739 |       17,208,369 |           23,510 |                0 |           22,758 |
|         76 |       ***** |1556906903320 |     749 |       17,208,369 |           23,510 |                0 |           22,443 |
|         77 |       ***** |1556906913058 |     759 |       17,208,369 |           23,510 |                0 |           22,155 |
|         78 |       ***** |1556906923087 |     769 |       17,208,369 |           23,510 |                0 |           21,866 |
|         79 |          30 |1556906933220 |     779 |       17,841,442 |           23,562 |           10,521 |           22,394 |
|         80 |          31 |1556906943041 |     789 |       18,924,142 |           23,809 |          110,243 |           23,487 |
|         81 |          32 |1556906952911 |     799 |       19,138,939 |           24,002 |           21,763 |           23,466 |
|         82 |       ***** |1556906963080 |     809 |       19,138,939 |           24,002 |                0 |           23,171 |
|         83 |       ***** |1556906972853 |     819 |       19,138,939 |           24,002 |                0 |           22,895 |
|         84 |       ***** |1556906982922 |     829 |       19,138,939 |           24,002 |                0 |           22,617 |
|         85 |       ***** |1556906993036 |     839 |       19,138,939 |           24,002 |                0 |           22,344 |
|         86 |       ***** |1556907003140 |     849 |       19,138,939 |           24,002 |                0 |           22,078 |
|         87 |          33 |1556907013012 |     859 |       20,052,602 |           24,057 |           15,202 |           22,888 |
|         88 |          34 |1556907023044 |     869 |       20,991,806 |           24,242 |           93,621 |           23,704 |
|         89 |          35 |1556907032857 |     879 |       21,217,669 |           24,390 |           23,017 |           23,697 |
|         90 |       ***** |1556907042856 |     889 |       21,217,669 |           24,390 |                0 |           23,430 |
|         91 |       ***** |1556907053013 |     899 |       21,217,669 |           24,390 |                0 |           23,166 |
|         92 |       ***** |1556907063038 |     909 |       21,217,669 |           24,390 |                0 |           22,910 |
|         93 |       ***** |1556907073184 |     919 |       21,217,669 |           24,390 |                0 |           22,657 |
|         94 |          36 |1556907083087 |     929 |       21,453,249 |           24,338 |            4,690 |           22,669 |
|         95 |          37 |1556907093248 |     939 |       22,155,665 |           24,373 |           69,129 |           23,172 |
|         96 |          38 |1556907102870 |     949 |       23,090,184 |           24,512 |           97,123 |           23,922 |
|         97 |          39 |1556907113249 |     959 |       23,325,884 |           24,626 |           22,709 |           23,908 |
|         98 |       ***** |1556907123001 |     969 |       23,325,884 |           24,626 |                0 |           23,668 |
|         99 |       ***** |1556907132971 |     979 |       23,325,884 |           24,626 |                0 |           23,427 |
|        100 |       ***** |1556907143057 |     989 |       23,325,884 |           24,626 |                0 |           23,188 |


Ingest rate of about 23k/s.  This is quite a bit slower than previous tests.

